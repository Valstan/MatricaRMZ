# Требования MatricaRMZ (извлечено из .docx)

Источник:
- `Контрольный лист ремонта двигателя.docx`
- `Описание программы Матрица РМЗ.docx`
- `ПРОЕКТ алгоритма.docx`

Цель этого документа: зафиксировать **поля**, **события процесса** и **где мы их храним** (EAV / operations / audit), чтобы дальше развивать проект модульно и без “угадываний”.

---

## 1) Сущности (MVP и ближайшее расширение)

### MVP (первый “боевой” процесс)
- **Двигатель**: карточка + таймлайн стадий/операций.
- **Операция (событие процесса)**: запись в таймлайне (приемка/комплектовка/дефектовка/ремонт/испытания + доп. события по доставке/упаковке/отгрузке).
- **Аудит действий**: кто/что/когда менял.

### Ближайшие сущности (из “Описание программы…”)
- **Контракт**, **Заказчик**, **Наряды**, **Рабочие/пользователи**, **Цеха/участки**, **Детали**, **Узлы двигателя**, **Шаблоны актов/отчетов**, **Файлы (облачное хранилище)**.

Технически это ложится на текущую схему как:
- **EAV**: новые типы сущностей и их свойства без миграций “на каждое поле”.
- **events/operations**: события процесса с `metaJson` для расширяемых полей.

---

## 2) Процесс (из “ПРОЕКТ алгоритма…”)

Высокоуровневый маршрут (таймлайн):
1) Договор/контракт → 2) Логистика (дата поставки) → 3) КПП/досмотр/документы → 4) Приемка на площадке (комплектность, номера, фото 5 ракурсов) → 5) (если некомплект) акт некомплектности + ответственное хранение + коммуникации с Заказчиком → 6) Разборка → 7) Дефектовка узлов/агрегатов → 8) Акт полной дефектовки (таблица) → 9) Заявка в снабжение по ЗИП → 10) Сборка с контролем номерного соответствия → 11) Испытания → 12) Акт исследований (оригинал получен) → 13) ОТК: проверка комплектности/разрешение упаковки → 14) Упаковка + место хранения → 15) Отгрузка + проверка упаковки/документов → 16) Подтверждение доставки/претензии.

---

## 3) Поля контрольного листа (из “Контрольный лист ремонта двигателя…”)

### 3.1 Основные поля “дела ремонта” (по двигателю)
- **Дата поставки двигателя**
- **Марка / № двигателя**
- **Сопроводительные документы**
- **Реквизиты паспорта двигателя**
- **Отметка о комплектности + недостающие детали**
- **Отметка о фотофиксации + место хранения файла**
- **Заявка на недостающие детали (агрегаты) в снабжение + дата**
- **Недостающие детали (агрегаты) приобретены + дата + основание**
- **Дата передачи двигателя на разборку + реквизиты акта приема в ремонт**
- **Дата и № акта полной дефектовки двигателя**
- **Заявка З/П (детали) в снабжение + дата**
- **З/П (детали) приобретены + дата + основание**
- **Контроль номерного соответствия при сборке (соответствует/нет) + перечень несоответствий**
- **Дата прохождения испытаний**
- **Дата и № акта исследований + оригинал акта получен**
- **Проверка комплектности двигателя с отметкой мастера ОТК**
- **Дата упаковки**
- **Место хранения упакованного двигателя**
- **Дата отгрузки**
- **Отметка о доставке Заказчику + наличие претензий + содержание претензий**
- **Кто составил акт (ФИО, должность, подпись)**

### 3.2 Табличные участки
1) **Список недостающих деталей (агрегатов)**: `(наименование, номер)`
2) **Несоответствующие детали при сборке**: `(наименование, номер)`
3) **Акт полной дефектовки** (Приложение №2): строки с узлами/деталями и признаками:
   - подлежит повторной установке (да/нет)
   - подлежит замене (да/нет)
   - примечание

---

## 4) Маппинг: экран → поля → где хранить

### Экран: “Двигатель / Карточка”
Хранение: **EAV (`attribute_defs/values`)**.
- `engine_number` (text) — уже есть
- `engine_brand` (text) — уже есть
- `delivery_date` (date)
- `passport_details` (text)
- `accompanying_docs` (text или json)
- `engine_photo` (link)
- (будущее) `contract_id` (link на сущность Контракт)

### Экран: “Таймлайн / Операции”
Хранение: **`operations`** (процессные события) + `metaJson` для расширяемых полей.

Рекомендуемый подход (MVP): каждое крупное событие — отдельная операция с типом и `performedAt`.
- `acceptance`: комплектность, фото, первичные документы, акты приемки/некомплектности, ответственное хранение.
- `kitting`: заявки в снабжение (агрегаты/ЗИП), статусы “отправлено/приобретено”, основания.
- `defect`: акт полной дефектовки (номер/даты) + таблица результатов (json).
- `repair`: контроль номерного соответствия + несоответствия.
- `test`: дата испытаний + акт исследований (номер/дата/оригинал получен).
- (доп. события для “дела ремонта”, можно включить в таймлайн):
  - `disassembly` (передача на разборку + реквизиты акта)
  - `otk` (проверка комплектности + отметка)
  - `packaging` (дата упаковки + место хранения)
  - `shipment` (отгрузка)
  - `customer_delivery` (доставка/претензии)

### Экран: “Отчеты”
Хранение: данные берутся из **двигателя (EAV)** + **операций (operations)**.
- Отчет по двигателю = “дело ремонта” (карточка + таймлайн + табличные приложения).
- Отчет по периоду = агрегирование по операциям (`operationType`, `performedAt`, `status`).

### Экран: “Справочники”
Хранение: **EAV**.
- управление `entity_types`
- управление `attribute_defs` (dataType, required, sortOrder, metaJson)

### Экран: “Журнал действий”
Хранение: `audit_log`.

---

## 5) Решения для реализации (чтобы проект масштабировался)

### 5.1 Где хранить табличные блоки (недостающие детали / дефектовка / несоответствия)
MVP: **JSON в `operations.metaJson`** (быстро, гибко, без множества новых таблиц).
Позже: вынести в отдельные сущности **“деталь/узел/позиция дефектовки”** (через EAV или отдельные таблицы) для аналитики и повторного использования.

### 5.2 Файлы (фото, сканы актов)
MVP: хранить **ссылку/путь** (link) + опциональные метаданные (json).
Позже: отдельный модуль “Файлы/хранилище” со своим синком (вне `change_log` JSON-строк).


